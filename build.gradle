/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/6.7/samples
 */
task install{
doLast {
        println 'install'
    }
}
task check{
    dependsOn 'install'
    doLast {
        println 'check'
    }
}
task build{
    dependsOn 'check'
    doLast {
        println 'build'
    }
}

task createVenv(type:Exec){
    onlyIf { file('venv').exists() == false }
    commandLine 'virtualenv', 'venv'
}

task installPoetry(type:Exec){
    onlyIf { file('venv/Scripts/poetry.exe').exists() == false }
    commandLine 'venv/Scripts/pip', 'install', 'poetry'
}

task installOiio(type:Exec){
    onlyIf { file('venv/Lib/site-packages/oiio').exists() == false }
    commandLine 'venv/Scripts/pip', 'install', '-r', 'oiio-requirements.txt'
}

task poetryInstall(type:Exec){
    dependsOn 'createVenv'
    dependsOn 'installPoetry'
    commandLine 'runInVenv.bat', 'poetry', 'install'
    inputs.file('pyproject.toml')
    inputs.file('poetry.lock')
    outputs.dir('venv')
}

task pytest(type:Exec){
    dependsOn 'createVenv'
    dependsOn 'installPoetry'
    commandLine 'runInVenv.bat', 'pytest', 'tests'
    inputs.dir('cato')
    inputs.dir('cato_server')
    inputs.dir('tests')
    outputs.dir('dist')
}

task poetryBuild(type:Exec){
    dependsOn 'createVenv'
    dependsOn 'installPoetry'
    commandLine 'runInVenv.bat', 'poetry', 'build'
    inputs.dir('cato')
    inputs.dir('cato_server')
    inputs.file('pyproject.toml')
    inputs.file('poetry.lock')
    outputs.dir('dist')
}

install.dependsOn('poetryInstall')
install.dependsOn('installOiio')
check.dependsOn('pytest')
build.dependsOn('poetryBuild')

/*task yarnInstall(type:Exec){
    workingDir 'frontend'
    commandLine 'yarn', 'install'
    inputs.file('frontend/package.json')
    inputs.file('frontend/yarn.lock')
    outputs.dir('frontend/node_modules')
}
task yarnBuild(type:Exec){
    workingDir 'frontend'
    commandLine 'yarn', 'build'
    inputs.dir('public')
    inputs.dir('src')
    outputs.dir('build')
}

install.dependsOn('yarnInstall')
build.dependsOn('yarnBuild')*/


task formatPython(type:Exec){
    commandLine 'venv/Scripts/black', 'cato', 'cato_server', 'tests'
}