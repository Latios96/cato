/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/6.7/samples
 */
 plugins {
    id "com.github.node-gradle.node" version "2.2.4"
}


task install{
doLast {
        println 'install'
    }
}
task check{
    dependsOn 'install'
    doLast {
        println 'check'
    }
}
task build{
    dependsOn 'check'
    doLast {
        println 'build'
    }
}

task createVenv(type:Exec){
    onlyIf { file('venv').exists() == false }
    commandLine 'virtualenv', 'venv'
}

task installPoetry(type:Exec){
    dependsOn 'createVenv'
    onlyIf { file('venv/Scripts/poetry.exe').exists() == false }
    commandLine 'venv/Scripts/pip', 'install', 'poetry'
}

task installOiio(type:Exec){
    onlyIf { file('venv/Lib/site-packages/oiio').exists() == false }
    commandLine 'venv/Scripts/pip', 'install', '-r', 'oiio-requirements.txt'
}

task poetryInstall(type:Exec){
    dependsOn 'installPoetry'
    commandLine 'runInVenv.bat', 'poetry', 'install'
    inputs.file('pyproject.toml')
    inputs.file('poetry.lock')
    outputs.file('poetryInstallOutput')
}

task pytest(type:Exec){
    dependsOn 'poetryInstall'
    commandLine 'runInVenv.bat', 'pytest', 'tests'
    inputs.dir('cato')
    inputs.dir('cato_server')
    inputs.dir('cato_api_client')
    inputs.dir('tests')
    outputs.dir('pytestOutput')
}

task copyFrontendToBuild {
    dependsOn(':frontend:yarnBuild')
    doLast {
        copy {
            from "${rootDir}/frontend/build"
            into "${rootDir}/cato_server/static"
        }
    }
}

task poetryBuild(type:Exec){
    dependsOn 'installPoetry'
    dependsOn 'pytest'
    dependsOn 'copyFrontendToBuild'
    commandLine 'runInVenv.bat', 'poetry', 'build'
    inputs.dir('cato')
    inputs.dir('cato_server')
    inputs.file('pyproject.toml')
    inputs.file('poetry.lock')
    outputs.dir('dist')
}

install.dependsOn('poetryInstall')
install.dependsOn('installOiio')
check.dependsOn('pytest')
build.dependsOn('poetryBuild')

install.dependsOn(':frontend:yarnInstallDependencies')

task formatPython(type:Exec){
    commandLine 'venv/Scripts/black', 'cato', 'cato_server', 'tests', 'cato_api_client', 'alembic'
}

task format{
    dependsOn 'formatPython'
    dependsOn ':frontend:formatJs'
}